name: Build Whisper Vulkan (Windows)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Chocolatey (if missing)
      shell: powershell
      run: |
        if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
        Set-ExecutionPolicy Bypass -Scope Process -Force
        iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
        }

    - name: Install Vulkan SDK (choco)
      shell: powershell
      run: |
        choco install -y vulkan-sdk
        $vpath = Get-ChildItem 'C:\VulkanSDK' | Sort-Object LastWriteTime -Descending | Select-Object -First 1
        echo "VULKAN_SDK=${vpath.FullName}" >> $env:GITHUB_ENV
        echo "PATH=${vpath.FullName}\Bin;${env:PATH}" >> $env:GITHUB_ENV

    - name: Install CMake
      uses: lukka/get-cmake@latest

    - name: Configure CMake (Vulkan)
      run: cmake -B build -DWHISPER_VULKAN=ON

    - name: Build
      run: cmake --build build --config Release

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: whisper-vulkan-windows
        path: build/bin/Release/**
